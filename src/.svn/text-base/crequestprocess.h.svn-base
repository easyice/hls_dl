/*
    <one line to give the program's name and a brief idea of what it does.>
    Copyright (C) 2012  elva <email>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/


#ifndef CREQUESTPROCESS_H
#define CREQUESTPROCESS_H

#include "cconnectionmgr.h"
#include "sphttpmsg.hpp"
#include "define.h"







class CHttpCore;

///HTTP请求处理
class CRequestProcess
{
public:
	CRequestProcess();
	~CRequestProcess();
	
	/**
	 * @brief 处理HTTP IN 请求
	 * @param strReq 完整的 HTTP 头
	 * @param nLen 字符串长度。不一定以 0 结尾,后面可能还有别的数据
	 * @return sock出错需要断开用户连接时 false
	 */
	bool ProcessNewRequest(const char* strReq,int nLen,CONNECTION_T* pConn);
	
	/**
	 * @brief 处理 IN 事件中没有发完的数据.如果是 NormalTs ，尝试继续读取剩余内容
	 * @return sock出错需要断开用户连接时 false
	 */
	bool ProcessContinue(CONNECTION_T* pConn);
	
	
private:
	
	/**
	 * @brief 解析请求类型
	 */
	REQ_TYPE_T GetRequestType(const SP_HttpRequest * request);
	
	bool CheckRequest(const SP_HttpRequest * request);

        /**
         * @brief 分配会话
         */
	bool AllocSession(const SP_HttpRequest * request,CONNECTION_T* pConn,bool bAllowReuse);
        
        /**
         * @brief 获取现有会话
         */
        bool GetSession(const SP_HttpRequest * request,CONNECTION_T* pConn);
        
        bool CheckAllocSession(REQ_TYPE_T reqType,const SP_HttpRequest * request,CONNECTION_T* pConn);
private:
	//临时缓冲，读取来的数据放这里。
	BYTE *m_pSendBuf;
	
	char* m_pHttpHead;
	
	CHttpCore* m_pHttpCore;
};

#endif // CHTTPREQUEST_H
